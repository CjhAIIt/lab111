<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lab.recruitment.mapper.UserMapper">

    <!-- 根据角色查询用户列表 -->
    <select id="selectUsersByRole" resultType="com.lab.recruitment.entity.User">
        SELECT id, username, password, real_name, role, student_id, college, major, grade,
               phone, email, lab_id, can_edit, create_time, update_time, status, deleted
        FROM t_user
        WHERE role = #{role} AND deleted = 0
        ORDER BY create_time DESC
    </select>
    
    <!-- 查询所有管理员（不包括总负责人） -->
    <select id="selectAllAdmins" resultType="com.lab.recruitment.entity.User">
        SELECT id, username, password, real_name, role, student_id, college, major, grade,
               phone, email, lab_id, can_edit, create_time, update_time, status, deleted
        FROM t_user
        WHERE role = 'admin' AND deleted = 0
        ORDER BY create_time DESC
    </select>
    
    <!-- 检查用户名是否存在（包含已删除记录） -->
    <select id="countByUsernameIncludeDeleted" resultType="int">
        SELECT COUNT(1)
        FROM t_user
        WHERE username = #{username} AND deleted = #{deleted}
    </select>
    
    <!-- 检查学号是否存在（包含已删除记录） -->
    <select id="countByStudentIdIncludeDeleted" resultType="int">
        SELECT COUNT(1)
        FROM t_user
        WHERE student_id = #{studentId} AND deleted = #{deleted}
    </select>
    
    <!-- 检查邮箱是否存在（包含已删除记录） -->
    <select id="countByEmailIncludeDeleted" resultType="int">
        SELECT COUNT(1)
        FROM t_user
        WHERE email = #{email} AND deleted = #{deleted}
    </select>
    
    <!-- 检查手机号是否存在（包含已删除记录） -->
    <select id="countByPhoneIncludeDeleted" resultType="int">
        SELECT COUNT(1)
        FROM t_user
        WHERE phone = #{phone} AND deleted = #{deleted}
    </select>
    
    <!-- 根据用户名和删除状态查找用户 -->
    <select id="findByUsernameAndDeleted" resultType="com.lab.recruitment.entity.User">
        SELECT id, username, password, real_name, role, student_id, college, major, grade,
               phone, email, lab_id, can_edit, create_time, update_time, status, deleted
        FROM t_user
        WHERE username = #{username} AND deleted = #{deleted}
    </select>
    
    <!-- 恢复已删除的用户记录 -->
    <update id="restoreDeletedUser">
        UPDATE t_user 
        SET username = #{username}, 
            password = #{password}, 
            real_name = #{realName}, 
            role = #{role}, 
            student_id = #{studentId}, 
            major = #{major}, 
            grade = #{grade}, 
            email = #{email}, 
            status = #{status},
            deleted = 0,
            update_time = NOW()
        WHERE id = #{id} AND deleted = 1
    </update>

</mapper>